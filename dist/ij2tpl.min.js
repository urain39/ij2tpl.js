(function(e,r){typeof exports==="object"&&typeof module!=="undefined"?r(exports):typeof define==="function"&&define.amd?define(["exports"],r):(e=e||self,r(e.IJ2TPL={}))})(this,function(e){"use strict";var r,t;var n="0.1.0-dev";var v={};function a(e){v=e}var h=(r={},r["?"]=0,r["!"]=1,r["*"]=2,r["/"]=3,r["#"]=5,r["@"]=8,r);var i=/^[\s\xA0\uFEFF]+|[\s\xA0\uFEFF]+$/g,p=function(e){return e.replace(i,"")},o=/(?:^|[\n\r])[\t \xA0\uFEFF]+$/,s=/[\t \xA0\uFEFF]+$/,d=function(e,r){if(e[0]===4){e=e;if(o.test(e[1]))e[1]=e[1].replace(s,"");if(!e[1])r.pop()}};function l(e,r,t){var n,a,i=[7,""],o=[];for(var s=0,l=0,f=e.length,c=r.length,u=t.length;s<f;){l=e.indexOf(r,s);if(l===-1){a=e.slice(s);if(a)i=[4,a],o.push(i);break}a=e.slice(s,l);l+=c;if(a)i=[4,a],o.push(i);s=e.indexOf(t,l);if(s===-1)throw new Error("No matching prefix '"+r+"'");if(e[l]==="-"){d(i,o);s+=u;continue}a=e.slice(l,s);s+=u;a=p(a);if(!a)continue;n=a[0];switch(n){case"?":case"!":case"*":case"/":case"@":d(i,o);if(s<f){switch(e[s]){case"\n":s+=1;break;case"\r":s+=s+1<f?e[s+1]==="\n"?2:1:1;break}}case"#":a=p(a.slice(1));i=[h[n],a],o.push(i);break;default:i=[6,a],o.push(i);break}}return o}var f=/["&'\/<=>`]/g,c={'"':"&quot;","&":"&amp;","'":"&#39;","/":"&#x2F;","<":"&lt;","=":"&#x3D;",">":"&gt;","`":"&#x60;"},g=function(e){return String(e).replace(f,function(e){return c[e]})};var u=g;var w={}.hasOwnProperty;var b=function(){function e(e,r){this.data=e;this.parent=r;this.cache={".":this.data}}e.prototype.resolve=function(e){var r,t,n=null,a=this;t=a.cache;if(w.call(t,e[0])){n=t[e[0]]}else{if(e[1]){var i=void 0,o=e[1];i=o[0];do{r=a.data;if(r&&w.call(r,i)){n=r[i];for(var s=1,l=o.length;s<l;s++){i=o[s];if(n&&w.call(n,i)){n=n[i]}else{n=null;break}}break}a=a.parent}while(a)}else{do{r=a.data;if(r&&w.call(r,e[0])){n=r[e[0]];break}a=a.parent}while(a)}if(typeof n==="function")n=n(a);if(e[2]){var f=e[2];for(var c=0,u=f;c<u.length;c++){var h=u[c];if(w.call(v,h))n=v[h](n);else throw new Error("Cannot resolve filter "+h)}}t[e[0]]=n}return n};return e}();var k=Array.isArray;if(!k){var x={}.toString;k=function(e){return x.call(e)==="[object Array]"}}var y=function(){function e(e){this.treeRoot=e}e.prototype.renderTree=function(e,r,t){var n,a,i="",o=false;for(var s=0,l=e;s<l.length;s++){var f=l[s];switch(f[0]){case 0:a=f;n=r.resolve(a[1]);o=k(n);if(o?n.length:n){if(o)for(var c=0,u=n;c<u.length;c++){var h=u[c];i+=this.renderTree(a[2],new b(h,r),t)}else i+=this.renderTree(a[2],new b(n,r),t)}break;case 1:a=f;n=r.resolve(a[1]);o=k(n);if(!(o?n.length:n))i+=this.renderTree(a[2],r,t);break;case 2:a=f;n=r.resolve(a[1]);o=k(n);if(o?n.length:n){if(o)for(var v=0,p=n;v<p.length;v++){var h=p[v];i+=this.renderTree(a[2],new b(h,r),t)}else i+=this.renderTree(a[2],new b(n,r),t)}else{i+=this.renderTree(a[3],r,t)}break;case 4:i+=f[1];break;case 5:f=f;n=r.resolve(f[1]);if(n!=null)i+=n;break;case 6:f=f;n=r.resolve(f[1]);if(n!=null)i+=typeof n==="number"?n:g(n);break;case 8:f=f;if(t&&w.call(t,f[1]))i+=this.renderTree(t[f[1]].treeRoot,r,t);else throw new Error("Cannot resolve partial template '"+f[1]+"'");break}}return i};e.prototype.render=function(e,r){return this.renderTree(this.treeRoot,new b(e,null),r)};return e}();var F=(t={},t[0]="?",t[1]="!",t[2]="*",t[3]="/",t);var E=/\s*\|\s*/,T=function(e){var r,t,n,a,i;r=e[1];t=r;if(r.indexOf("|")!==-1){a=r.split(E);r=a[0];a=a.slice(1)}if(r.indexOf(".")>0){n=r.split(".")}i=[e[0],[t,n,a]];return i};function m(e){var r,t,n=[],a=[],i=a;for(var o=0,s=e;o<s.length;o++){var l=s[o];switch(l[0]){case 0:case 1:r=T(l);t=r;i.push(t);n.push(t);i=t[2]=[];break;case 2:t=n.length?n[n.length-1]:void 38370;if(!t||t[0]!==0||l[1]!==t[1][0])throw new Error("Unexpected token '<type="+F[l[0]]+", value="+l[1][0]+">'");i=t[3]=[];break;case 3:t=n.pop();if(!t||l[1]!==t[1][0])throw new Error("Unexpected token '<type="+F[l[0]]+", value="+l[1][0]+">'");if(k(t[3])&&t[3].length)t[0]=2;i=n.length?(t=n[n.length-1],k(t[3]))?t[3]:t[2]:a;break;case 5:case 6:r=T(l);i.push(r);break;default:i.push(l);break}}if(n.length){t=n.pop();throw new Error("No matching section '<type="+F[t[0]]+", value="+t[1][0]+">'")}return a}function A(e,r,t){if(r===void 0){r="{"}if(t===void 0){t="}"}var n=m(l(e,r,t));return new y(n)}e.Context=b;e.Renderer=y;e.escape=u;e.parse=A;e.setFilterMap=a;e.tokenize=l;e.version=n;Object.defineProperty(e,"__esModule",{value:true})});