(function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).IJ2TPL={})})(this,function(e){"use strict";function v(e,r){var t,n,a="";return 4===e[0]&&((n=(t=e[1]).match(i))&&(a=n[2],t=t.replace(o,"")),t?e[1]=t:r.pop()),a}function g(e){return e.replace(t,"\\$&")}var r,p={},w=((r={})["?"]=0,r["!"]=1,r["*"]=2,r["/"]=3,r["#"]=5,r["@"]=8,r),i=/(^|[\n\r])([\t \xA0\uFEFF]+)$/,o=/[\t \xA0\uFEFF]+$/,b=/[\s\xA0\uFEFF]+/g,t=/[-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g;function n(e,r,t){for(var n,a,i,o,s,l=new RegExp(g(r)+"[\t ]*"+g(t),"g"),c=[7,""],f=[],u=0,h=(e=e.replace(l,"")).length,p=r.length,d=t.length;u<h;){if(-1===(o=e.indexOf(r,u))){(a=e.slice(u))&&f.push(c=[4,a]);break}if(a=e.slice(u,o),o+=p,a&&f.push(c=[4,a]),-1===(u=e.indexOf(t,o)))throw new Error("No matching prefix '"+r+"'");if("-"!==e.charAt(o))switch(a=e.slice(o,u),u+=d,s=a,n=(a=s.replace(b,"")).charAt(0)){case"?":case"!":case"*":case"/":case"@":if(i=v(c,f),u<h)switch(e.charAt(u)){case"\n":u+=1;break;case"\r":u+=(o=u+1)<h&&"\n"===e.charAt(o)?2:1}c=[w[n],a.slice(1),i],f.push(c);break;case"#":c=[w[n],a.slice(1)],f.push(c);break;default:f.push(c=[6,a])}else v(c,f),u+=d,c=[7,""]}return f}function k(e){return String(e).replace(a,function(e){return s[e]})}var x={}.hasOwnProperty,a=/["&'\/<=>`]/g,s={'"':"&quot;","&":"&amp;","'":"&#39;","/":"&#x2F;","<":"&lt;","=":"&#x3D;",">":"&gt;","`":"&#x60;"},y=k,T=(l.prototype.resolve=function(e){var r,t,n,a,i,o,s=null,l=this,c=!1;if(!e[3])if(t=l.cache,n=e[0],x.call(t,n))s=t[n];else{(i=e[1])?(a=i[0],c=!0):a=n;do{if((r=l.data)&&x.call(r,a)){if(s=r[a],c)for(var f=1,u=i.length;f<u;f++){if(a=i[f],!s||!x.call(s,a)){s=null;break}s=s[a]}break}}while(l=l.parent);"function"==typeof s&&(s=s(l)),t[n]=s}if(o=e[2])for(var h,f=0,u=o.length;f<u;){if(h=o[f++],!x.call(p,h))throw new Error("Cannot resolve filter '"+h+"'");s=p[h](s,l)}return s},l);function l(e,r){this.data=e,this.cache={".":this.data},this.parent=r}var c,F=Array.isArray;F||(c={}.toString,F=function(e){return"[object Array]"===c.call(e)});var f=(u.prototype.renderTree=function(e,r,t){for(var n,a,i,o,s,l=/^(.+)$/gm,c="",f=!1,u=0,h=e.length;u<h;)switch((s=e[u++])[0]){case 0:if(n=r.resolve((i=s)[1]),(f=F(n))?a=n.length:n)if(f)for(var p=0,d=a,v=void 0;p<d;)v=n[p++],c+=this.renderTree(i[2],new T(v,r),t);else c+=this.renderTree(i[2],new T(n,r),t);break;case 1:n=r.resolve((i=s)[1]),((f=F(n))?n.length:n)||(c+=this.renderTree(i[2],r,t));break;case 2:if(n=r.resolve((i=s)[1]),(f=F(n))?a=n.length:n)if(f)for(var g=0,w=a,v=void 0;g<w;)v=n[g++],c+=this.renderTree(i[2],new T(v,r),t);else c+=this.renderTree(i[2],new T(n,r),t);else c+=this.renderTree(i[3],r,t);break;case 4:c+=n=s[1];break;case 5:null!=(n=r.resolve(s[1]))&&(c+=n);break;case 6:null!=(n=r.resolve(s[1]))&&(c+=y===k&&"number"==typeof n?n:y(n));break;case 8:if(n=s[1],o=s[2],"&"===n)c+=this.renderTree(this.treeRoot,r,t).replace(l,o+"$&");else if("^"===n)c+=this.renderTree(this.treeRoot,new T(r.data,null),t).replace(l,o+"$&");else{if(!t||!x.call(t,n))throw new Error("Cannot resolve partial '"+n+"'");c+=this.renderTree(t[n].treeRoot,r,t).replace(l,o+"$&")}}return c},u.prototype.render=function(e,r){return this.renderTree(this.treeRoot,new T(e,null),r)},u);function u(e){this.treeRoot=e}function d(e){var r=null,t=null,n=!1,a=e[1];return-1!==a.indexOf("|")&&(a=(t=a.split("|"))[0],t=t.slice(1),a||(n=!0)),0<a.indexOf(".")&&(r=a.split(".")),[e[0],[a,r,t,n]]}var E=((r={})[0]="?",r[1]="!",r[2]="*",r[3]="/",r);e.Context=T,e.Renderer=f,e.escape=function(e){return y(e)},e.parse=function(e,r,t){return t=function(e){for(var r,t,n,a,i,o,s,l=[],c=[],f=c,u=0,h=e.length;u<h;)switch(r=(s=e[u++])[0]){case 0:case 1:n=d(s),f.push(n),i=n,l.push(i),f=i[2]=[],i[3]=null;break;case 2:if(i=(o=l.length)?l[o-1]:void 0,t=s[1],!i||0!==i[0]||t!==i[1][0])throw new Error("Unexpected token '<type="+E[r]+", value="+t+">'");f=i[3]=[];break;case 3:if(i=l.pop(),t=s[1],!i||t!==i[1][0])throw new Error("Unexpected token '<type="+E[r]+", value="+t+">'");i[3]&&(i[0]=2),f=(o=l.length)?(a=(i=l[o-1])[3])?a:i[2]:c;break;case 5:case 6:n=d(s),f.push(n);break;default:f.push(s)}if(l.length)throw i=l.pop(),new Error("No matching section '<type="+E[i[0]]+", value="+i[1][0]+">'");return c}(n(e,r=void 0===r?"{":r,t=void 0===t?"}":t)),new f(t)},e.setEscapeFunction=function(e){y=e},e.setFilterMap=function(e){p=e},e.tokenize=n,e.version="0.1.3",e.__esModule=!0});