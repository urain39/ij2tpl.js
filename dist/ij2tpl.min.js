(function(e,r){typeof exports==="object"&&typeof module!=="undefined"?r(exports):typeof define==="function"&&define.amd?define(["exports"],r):(e=e||self,r(e.IJ2TPL={}))})(this,function(e){"use strict";var r,t;var n="0.1.0-dev";var h=(r={},r["?"]=0,r["!"]=1,r["*"]=2,r["/"]=3,r["#"]=5,r["@"]=8,r);var a=/^[\s\xA0\uFEFF]+|[\s\xA0\uFEFF]+$/g,p=function(e){return e.replace(a,"")},i=/(?:^|[\n\r])[\t \xA0\uFEFF]+$/,o=/[\t \xA0\uFEFF]+$/g,v=function(e,r){if(e[0]===4){if(i.test(e[1]))e[1]=e[1].replace(o,"");if(!e[1])r.pop()}};function s(e,r,t){var n,a,i=[7,""],o=[];for(var s=0,f=0,l=e.length,c=r.length,u=t.length;s<l;){f=e.indexOf(r,s);if(f===-1){a=e.slice(s);if(a)i=[4,a],o.push(i);break}a=e.slice(s,f);f+=c;if(a)i=[4,a],o.push(i);s=e.indexOf(t,f);if(s===-1)throw new Error("No matching prefix '"+r+"'");if(e[f]==="-"){v(i,o);s+=u;continue}a=e.slice(f,s);s+=u;a=p(a);if(!a)continue;n=a[0];switch(n){case"?":case"!":case"*":case"/":v(i,o);if(s<l){switch(e[s]){case"\n":s+=1;break;case"\r":s+=s+1<l?e[s+1]==="\n"?2:1:1;break}}case"#":case"@":a=p(a.slice(1));i=[h[n],a],o.push(i);break;default:i=[6,a],o.push(i);break}}return o}var f=/["&'\/<=>`]/g,l={'"':"&quot;","&":"&amp;","'":"&#39;","/":"&#x2F;","<":"&lt;","=":"&#x3D;",">":"&gt;","`":"&#x60;"},d=function(e){return String(e).replace(f,function(e){return l[e]})};var c=d;var g={}.hasOwnProperty;var b=function(){function e(e,r){this.data=e;this.parent=r;this.cache={".":this.data}}e.prototype.resolve=function(e){var r,t,n=null,a=this;t=a.cache;if(g.call(t,e)){n=t[e]}else{if(e.indexOf(".")>0){var i=void 0,o=e.split(".");i=o[0];for(;a;a=a.parent){r=a.data;if(r&&g.call(r,i)){n=r[i];for(var s=1,f=o.length;s<f;s++){i=o[s];if(n&&g.call(n,i)){n=n[i]}else{n=null;break}}break}}}else{for(;a;a=a.parent){r=a.data;if(r&&g.call(r,e)){n=r[e];break}}}if(typeof n==="function")n=n(a);t[e]=n}return n};return e}();var k=Array.isArray;if(!k){var u={}.toString;k=function(e){return u.call(e)==="[object Array]"}}var w=function(){function e(e){this.root=e}e.prototype.renderTree=function(e,r,t){var n,a,i="",o=false;for(var s=0,f=e;s<f.length;s++){var l=f[s];switch(l[0]){case 0:a=l;n=r.resolve(a[1]);o=k(n);if(o?n.length>0:n){if(o)for(var c=0,u=n;c<u.length;c++){var h=u[c];i+=this.renderTree(a[2],new b(h,r),t)}else i+=this.renderTree(a[2],new b(n,r),t)}break;case 1:a=l;n=r.resolve(a[1]);o=k(n);if(o?n.length<1:!n)i+=this.renderTree(a[2],r,t);break;case 2:a=l;n=r.resolve(a[1]);o=k(n);if(o?n.length>0:n){if(o)for(var p=0,v=n;p<v.length;p++){var h=v[p];i+=this.renderTree(a[2],new b(h,r),t)}else i+=this.renderTree(a[2],new b(n,r),t)}else{i+=this.renderTree(a[3],r,t)}break;case 4:i+=l[1];break;case 5:n=r.resolve(l[1]);if(n!=null)i+=n;break;case 6:n=r.resolve(l[1]);if(n!=null)i+=typeof n==="number"?n:d(n);break;case 8:if(t&&g.call(t,l[1]))i+=this.renderTree(t[l[1]].root,r,t);else throw new Error("Cannot resolve partial template '"+l[1]+"'")}}return i};e.prototype.render=function(e,r){return this.renderTree(this.root,new b(e,null),r)};return e}();var x=(t={},t[0]="?",t[1]="!",t[2]="*",t[3]="/",t);function y(e){var r,t=[],n=[],a=n;for(var i=0,o=e;i<o.length;i++){var s=o[i];switch(s[0]){case 0:case 1:a.push(s);r=s;t.push(r);a=r[2]=[];break;case 2:r=t.length>0?t[t.length-1]:void 38370;if(!r||r[0]!==0||s[1]!==r[1])throw new Error("Unexpected token '<type="+x[s[0]]+", value="+s[1]+">'");a=r[3]=[];break;case 3:r=t.pop();if(!r||s[1]!==r[1])throw new Error("Unexpected token '<type="+x[s[0]]+", value="+s[1]+">'");if(k(r[3])&&r[3].length>0)r[0]=2;if(t.length>0)a=(r=t[t.length-1],k(r[3]))?r[3]:r[2];else a=n;break;default:a.push(s);break}}if(t.length>0){r=t.pop();throw new Error("No matching section '<type="+x[r[0]]+", value="+r[1]+">'")}return n}function F(e,r,t){if(r===void 0){r="{"}if(t===void 0){t="}"}var n=y(s(e,r,t));return new w(n)}e.Context=b;e.Renderer=w;e.escape=c;e.parse=F;e.tokenize=s;e.version=n;Object.defineProperty(e,"__esModule",{value:true})});