(function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).IJ2TPL={})})(this,function(w){"use strict";function h(e,r){var t;4===e[0]&&(t=e[1],n.test(t)&&(t=t.replace(i,"")),t?e[1]=t:r.pop())}var e,p={},d=((e={})["?"]=0,e["!"]=1,e["*"]=2,e["/"]=3,e["#"]=5,e["@"]=8,e),v=/[\s\xA0\uFEFF]+/g,n=/(?:^|[\n\r])[\t \xA0\uFEFF]+$/,i=/[\t \xA0\uFEFF]+$/;function a(e,r,t){for(var n,i,a,o=[7,""],s=[],l=0,c=e.length,f=r.length,u=t.length;l<c;){if(-1===(a=e.indexOf(r,l))){(i=e.slice(l))&&(o=[4,i],s.push(o));break}if(i=e.slice(l,a),a+=f,i&&(o=[4,i],s.push(o)),-1===(l=e.indexOf(t,a)))throw new Error("No matching prefix '"+r+"'");if("-"!==e[a]){if(i=e.slice(a,l),l+=u,i=i.replace(v,""))switch(n=i[0]){case"?":case"!":case"*":case"/":case"@":if(h(o,s),l<c)switch(e[l]){case"\n":l+=1;break;case"\r":l+=(a=l+1)<c&&"\n"===e[a]?2:1}case"#":o=[d[n],i.slice(1)],s.push(o);break;default:o=[6,i],s.push(o)}}else h(o,s),l+=u}return s}var g={}.hasOwnProperty,r=/["&'\/<=>`]/g,t={'"':"&quot;","&":"&amp;","'":"&#39;","/":"&#x2F;","<":"&lt;","=":"&#x3D;",">":"&gt;","`":"&#x60;"};w.escape=function(e){return String(e).replace(r,function(e){return t[e]})};var b=(o.prototype.resolve=function(e){var r,t,n,i,a,o,s=null,l=this,c=!1;if(!e[3])if(t=l.cache,n=e[0],g.call(t,n))s=t[n];else{(a=e[1])?(i=a[0],c=!0):i=n;do{if((r=l.data)&&g.call(r,i)){if(s=r[i],c)for(var f=1,u=a.length;f<u;f++){if(i=a[f],!s||!g.call(s,i)){s=null;break}s=s[i]}break}}while(l=l.parent);"function"==typeof s&&(s=s(l)),t[n]=s}if(o=e[2])for(var h,f=0,u=o.length;f<u;){if(h=o[f++],!g.call(p,h))throw new Error("Cannot resolve filter '"+h+"'");s=p[h](s)}return s},o);function o(e,r){this.data=e,this.cache={".":this.data},this.parent=r}var s,k=Array.isArray;k||(s={}.toString,k=function(e){return"[object Array]"===s.call(e)});var l=(c.prototype.renderTree=function(e,r,t){for(var n,i,a,o,s="",l=!1,c=0,f=e.length;c<f;)switch((o=e[c++])[0]){case 0:if(a=o,n=r.resolve(a[1]),(l=k(n))?i=n.length:n)if(l)for(var u=0,h=i,p=void 0;u<h;)p=n[u++],s+=this.renderTree(a[2],new b(p,r),t);else s+=this.renderTree(a[2],new b(n,r),t);break;case 1:a=o,n=r.resolve(a[1]),((l=k(n))?n.length:n)||(s+=this.renderTree(a[2],r,t));break;case 2:if(a=o,n=r.resolve(a[1]),(l=k(n))?i=n.length:n)if(l)for(var d=0,v=i,p=void 0;d<v;)p=n[d++],s+=this.renderTree(a[2],new b(p,r),t);else s+=this.renderTree(a[2],new b(n,r),t);else s+=this.renderTree(a[3],r,t);break;case 4:s+=n=o[1];break;case 5:null!=(n=r.resolve(o[1]))&&(s+=n);break;case 6:null!=(n=r.resolve(o[1]))&&(s+="number"==typeof n?n:w.escape(n));break;case 8:if(n=o[1],!t||!g.call(t,n))throw new Error("Cannot resolve partial '"+n+"'");s+=this.renderTree(t[n].treeRoot,r,t)}return s},c.prototype.render=function(e,r){return this.renderTree(this.treeRoot,new b(e,null),r)},c);function c(e){this.treeRoot=e}function x(e){var r=null,t=null,n=!1,i=e[1];return-1!==i.indexOf("|")&&(i=(t=i.split("|"))[0],t=t.slice(1),i||(n=!0)),0<i.indexOf(".")&&(r=i.split(".")),[e[0],[i,r,t,n]]}var y=((e={})[0]="?",e[1]="!",e[2]="*",e[3]="/",e);w.Context=b,w.Renderer=l,w.escapeOptimize=!0,w.parse=function(e,r,t){return void 0===r&&(r="{"),void 0===t&&(t="}"),t=function(e){for(var r,t,n,i,a,o,s,l=[],c=[],f=c,u=0,h=e.length;u<h;)switch(r=(s=e[u++])[0]){case 0:case 1:n=x(s),f.push(n),a=n,l.push(a),f=a[2]=[],a[3]=null;break;case 2:if(a=(o=l.length)?l[o-1]:void 0,t=s[1],!a||0!==a[0]||t!==a[1][0])throw new Error("Unexpected token '<type="+y[r]+", value="+t+">'");f=a[3]=[];break;case 3:if(a=l.pop(),t=s[1],!a||t!==a[1][0])throw new Error("Unexpected token '<type="+y[r]+", value="+t+">'");a[3]&&(a[0]=2),f=(o=l.length)?(i=(a=l[o-1])[3])?i:a[2]:c;break;case 5:case 6:n=x(s),f.push(n);break;default:f.push(s)}if(l.length)throw a=l.pop(),new Error("No matching section '<type="+y[a[0]]+", value="+a[1][0]+">'");return c}(a(e,r,t)),new l(t)},w.setEscapeFunction=function(e){w.escape=e},w.setFilterMap=function(e){p=e},w.tokenize=a,w.version="0.1.1",w.__esModule=!0});