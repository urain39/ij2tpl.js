(function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e=e||self).IJ2TPL={})})(this,function(e){"use strict";function h(e,r){var t;4===e[0]&&(t=e[1],n.test(t)&&(t=t.replace(a,"")),t?e[1]=t:r.pop())}var r,t,d={},p=((r={})["?"]=0,r["!"]=1,r["*"]=2,r["/"]=3,r["#"]=5,r["@"]=8,r),v=/[\s\xA0\uFEFF]+/g,n=/(?:^|[\n\r])[\t \xA0\uFEFF]+$/,a=/[\t \xA0\uFEFF]+$/;function u(e,r,t){for(var n,a,i,o=[7,""],l=[],s=0,c=e.length,f=r.length,u=t.length;s<c;){if(-1===(i=e.indexOf(r,s))){(a=e.slice(s))&&(o=[4,a],l.push(o));break}if(a=e.slice(s,i),i+=f,a&&(o=[4,a],l.push(o)),-1===(s=e.indexOf(t,i)))throw new Error("No matching prefix '"+r+"'");if("-"!==e[i]){if(a=e.slice(i,s),s+=u,a=a.replace(v,""))switch(n=a[0]){case"?":case"!":case"*":case"/":case"@":if(h(o,l),s<c)switch(e[s]){case"\n":s+=1;break;case"\r":s+=s+1<c&&"\n"===e[s+1]?2:1}case"#":o=[p[n],a.slice(1)],l.push(o);break;default:o=[6,a],l.push(o)}}else h(o,l),s+=u}return l}function w(e){return String(e).replace(i,function(e){return o[e]})}var i=/["&'\/<=>`]/g,o={'"':"&quot;","&":"&amp;","'":"&#39;","/":"&#x2F;","<":"&lt;","=":"&#x3D;",">":"&gt;","`":"&#x60;"},l=w,g={}.hasOwnProperty,b=(s.prototype.resolve=function(e){var r,t,n,a,i,o=null,l=this,s=l.cache;if(!e[3])if(t=e[0],g.call(s,t))o=s[t];else{if(a=e[1]){n=a[0];do{if((r=l.data)&&g.call(r,n)){o=r[n];for(var c=1,f=a.length;c<f;c++){if(n=a[c],!o||!g.call(o,n)){o=null;break}o=o[n]}break}l=l.parent}while(l)}else do{if((r=l.data)&&g.call(r,t)){o=r[t];break}l=l.parent}while(l);"function"==typeof o&&(o=o(l)),s[t]=o}if(i=e[2])for(var u=0,h=i;u<h.length;u++){var p=h[u];if(!g.call(d,p))throw new Error("Cannot resolve filter '"+p+"'");o=d[p](o)}return o},s);function s(e,r){this.data=e,this.parent=r,this.cache={".":this.data}}var c,k=Array.isArray;k||(c={}.toString,k=function(e){return"[object Array]"===c.call(e)});var y=(f.prototype.renderTree=function(e,r,t){for(var n,a,i="",o=!1,l=0,s=e;l<s.length;l++){var c=s[l];switch(c[0]){case 0:if(a=c,n=r.resolve(a[1]),(o=k(n))?n.length:n)if(o)for(var f=0,u=n;f<u.length;f++){var h=u[f];i+=this.renderTree(a[2],new b(h,r),t)}else i+=this.renderTree(a[2],new b(n,r),t);break;case 1:a=c,n=r.resolve(a[1]),((o=k(n))?n.length:n)||(i+=this.renderTree(a[2],r,t));break;case 2:if(a=c,n=r.resolve(a[1]),(o=k(n))?n.length:n)if(o)for(var p=0,d=n;p<d.length;p++)h=d[p],i+=this.renderTree(a[2],new b(h,r),t);else i+=this.renderTree(a[2],new b(n,r),t);else i+=this.renderTree(a[3],r,t);break;case 4:i+=n=c[1];break;case 5:null!=(n=r.resolve(c[1]))&&(i+=n);break;case 6:null!=(n=r.resolve(c[1]))&&(i+="number"==typeof n?n:w(n));break;case 8:if(n=c[1],!t||!g.call(t,n))throw new Error("Cannot resolve partial '"+n+"'");i+=this.renderTree(t[n].treeRoot,r,t)}}return i},f.prototype.render=function(e,r){return this.renderTree(this.treeRoot,new b(e,null),r)},f);function f(e){this.treeRoot=e}function x(e){var r=null,t=null,n=!1,a=e[1];return-1!==a.indexOf("|")&&(a=(t=a.split("|"))[0],t=t.slice(1),T[a]&&(n=!0)),0<a.indexOf(".")&&(r=a.split(".")),[e[0],[a,r,t,n]]}var F=((t={})[0]="?",t[1]="!",t[2]="*",t[3]="/",t),T={"":!0,do:!0};Object.defineProperty||(Object.defineProperty=function(){}),e.Context=b,e.Renderer=y,e.escape=l,e.parse=function(s,c,f){void 0===c&&(c="{"),void 0===f&&(f="}");var e=function(){for(var e,r,t=[],n=[],a=n,i=0,o=u(s,c,f);i<o.length;i++){var l=o[i];switch(l[0]){case 0:case 1:e=x(l),a.push(e),r=e,t.push(r),a=r[2]=[],r[3]=null;break;case 2:if(!(r=t.length?t[t.length-1]:void 0)||0!==r[0]||l[1]!==r[1][0])throw new Error("Unexpected token '<type="+F[l[0]]+", value="+l[1][0]+">'");a=r[3]=[];break;case 3:if(!(r=t.pop())||l[1]!==r[1][0])throw new Error("Unexpected token '<type="+F[l[0]]+", value="+l[1][0]+">'");r[3]&&(r[0]=2),a=t.length?(r=t[t.length-1])[3]?r[3]:r[2]:n;break;case 5:case 6:e=x(l),a.push(e);break;default:a.push(l)}}if(t.length)throw r=t.pop(),new Error("No matching section '<type="+F[r[0]]+", value="+r[1][0]+">'");return n}();return new y(e)},e.setFilterMap=function(e){d=e},e.tokenize=u,e.version="0.1.0-dev",Object.defineProperty(e,"__esModule",{value:!0})});